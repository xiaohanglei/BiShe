#include "attendance.h"
#include <QPushButton>
#include <windows.h>
#include <process.h>
AttendanceM	::AttendanceM(QString clroom, TcpClient * tcpc, int method, QWidget *parent)
	: classroom(clroom),tcpclient(tcpc), m_method(method),QWidget(parent)
{
	attendance = new ATTEND;
	isLeisure = true;//初始空闲状态
	iscomplete = false;//
	isrecvdata = false;
	//ui.setupUi(this);
	SetupUi();

	connect(buttok, SIGNAL(clicked()), this, SLOT(SendReQuest()));
	QObject::connect(tcpclient->GetSock(), &QTcpSocket::readyRead, this, &AttendanceM::RecvHuiZhiPro);
	QObject::connect(&deal, &CDeal::RecvAttenance, this, &AttendanceM::slotSign);
	


	_beginthread(SendOrderPro, 0, this);
	
}

AttendanceM::~AttendanceM()
{

}
void AttendanceM::SendOrderPro(PVOID another)
{
	AttendanceM * attend = (AttendanceM *)another;

	while (1)
	{
		Sleep(60000 * 5);//分钟
		if (attend->isLeisure)//是否空闲
		{
			//发送请求待考勤名单命令
			SendReQuest(attend);

			//等待回执
			int waittime = 0;
			while (!attend->isrecvdata)
			{
				Sleep(1000 * 2);
				waittime++;

				if (waittime == 12 * 2)//如果超过2分钟则放弃等待
					break;
				
			}
			if (attend->isrecvdata)//收到回执
			{
				attend->isLeisure = false;//将状态设置非空闲
				attend->isrecvdata = false;

				if (attend->attendance->Stuends.size() != 0)
				{
					//准备开始考勤()
					Attend(NULL);
				}
				
			}
			
		}
		else//如果不是空闲状态，则判断是否考勤完毕
		{
			if (attend->iscomplete)
			{
				//推送考勤结果命令
				attend->isLeisure = true;//将状态设置空闲

				attend->iscomplete = false;


			}
			continue;
		}
	}
}

void AttendanceM::SendReQuest(AttendanceM * another)
{
	UCHAR * ptrSendData = new UCHAR[MAX_BUFF];
	int sendlen = 0;
	ptrSendData[4] = 0x8f;

	char mdzm[7] = "Server";
	char *sozm = nullptr;
	QByteArray tempQB = another->classroom.toLatin1();
	sozm = tempQB.data();

	memcpy(&ptrSendData[5], mdzm, 6);
	memcpy(&ptrSendData[11], sozm, 6);
	ptrSendData[17] = 0x01;
	ptrSendData[18] = 0x11;

	sendlen += 14;

	ptrSendData[sendlen + 5] = 0xff;
	sendlen += 1;
	memcpy(&ptrSendData[0], &sendlen, 4);

	another->tcpclient->GetSock()->write(((char *)ptrSendData),sendlen + 5);


	delete[]ptrSendData;

}
void AttendanceM::RecvHuiZhiPro()
{
	//
	QByteArray recvbyte;

	recvbyte = tcpclient->GetSock()->readAll();

	int recvlen = recvbyte.size();
	UCHAR * netbao = 0;
	netbao = (UCHAR *)recvbyte.data();

	
	deal.FenLiZhen(netbao, recvlen, attendance);//调用处理模块将接受到的数据分帧 


}

void AttendanceM::slotSign()
{
	//
	isrecvdata = true;//收到数据

#if 1
	QString input = editinput->text();

	for (auto it = attendance->Stuends.begin(); it != attendance->Stuends.end(); it++)
	{
		if (m_method == 0)//学号签到
		{
			if (input == it->StuId)
			{
				it->StuSign = true;
				attendance->signcount++;//签到一个人，记录一下
			}
		}
		else//指纹签到
		{
			if (input == it->StuFinger)
			{
				it->StuSign = true;
			}

		}
	}
#endif
}

void AttendanceM::Attend(AttendanceM * another)
{
	//

	int currtime = QDateTime::currentDateTime().toTime_t();//当前时间的时间戳

	//
	Sleep(another->attendance->starttime - currtime);//延时等待到开始时间



	while (1)
	{
		Sleep(5000);
		currtime = QDateTime::currentDateTime().toTime_t();//当前时间的时间戳
		if ( currtime > another->attendance->endtiem || another->attendance->signcount == another->attendance->Stuends.size())//当考勤时间结束或者，已经全部签到完毕以后
		{
			another->iscomplete = true;//完成考勤
			break;
		}
	}	
}

void AttendanceM::SetupUi()
{
	this->setWindowTitle(tr("Attendance Machine Simulator"));
	this->setWindowFlags(Qt::WindowCloseButtonHint | Qt::WindowMinimizeButtonHint/* | Qt::WindowMaximizeButtonHint*//*| Qt::Widget | Qt::FramelessWindowHint | Qt::WindowSystemMenuHint | Qt::WindowStaysOnTopHint*/);//关闭和最小化按钮
																																																					  //this->setWindowFlags(Qt::Widget | Qt::FramelessWindowHint | Qt::WindowSystemMenuHint | Qt::WindowStaysOnTopHint);

	this->setFixedSize(QSize(400, 200));



	editinput = new QLineEdit;
	QLabel * label1;
	if (m_method == 0)//学号签到
	{
		label1 = new QLabel(tr("StuId"));
	}
	else
	{
		label1 = new QLabel(tr("Finger"));
	}
	buttok = new QPushButton(tr("submit"));
	QHBoxLayout * layout_border = new QHBoxLayout;

	layout_border->addStretch(1);
	layout_border->addWidget(label1);
	layout_border->addWidget(editinput);
	layout_border->addWidget(buttok);
	layout_border->addStretch(1);

	QVBoxLayout * layout_main = new QVBoxLayout;
	layout_main->addStretch(1);
	layout_main->addLayout(layout_border);
	layout_main->addStretch(1);


	this->setLayout(layout_main);



}
